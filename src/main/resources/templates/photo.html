<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Upload a Photo ‚Äì Knightfam</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"/>
    <style>
    body { background: #f8f9fa; padding-top: 80px; }
    .upload-card { max-width: 500px; margin: auto; }
  </style>
</head>
<body>
<!-- Navbar -->
<div th:replace="~{fragments/menu :: menu}"></div>

<div class="container py-5">
    <div class="card shadow upload-card">
        <div class="card-header bg-primary text-white text-center">
            <h3>üì§ Upload a Family Photo</h3>
        </div>
        <div class="card-body">
            <!--
              action="/upload" ‚Üí your Thymeleaf WebController (redirects ‚Üí /gallery)
              data-api-url="/api/photos/upload" ‚Üí your REST endpoint (returns JSON)
            -->
            <form
                    id="uploadForm"
                    th:action="@{/upload}"
                    th:attr="data-api-url=@{/api/photos/upload}"
                    method="post"
                    enctype="multipart/form-data"
            >
                <div class="mb-3">
                    <label for="title" class="form-label">Photo Title</label>
                    <input
                            type="text"
                            id="title"
                            name="title"
                            class="form-control"
                            placeholder="Enter a title"
                            required
                    />
                </div>

                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea
                            id="description"
                            name="description"
                            class="form-control"
                            rows="3"
                            placeholder="Optional description"
                    ></textarea>
                </div>

                <!-- big tappable file picker, no capture attr -->
                <label
                        class="btn btn-outline-secondary w-100 mb-3 position-relative"
                        style="overflow:hidden"
                >
                    Choose Photo
                    <input
                            id="fileInput"
                            type="file"
                            name="file"
                            accept="image/*"
                            required
                            style="
                position:absolute;
                top:0; left:0;
                width:100%; height:100%;
                opacity:0;
                cursor:pointer;
              "
                    />
                </label>

                <noscript>
                    <div class="mb-3">
                        <input
                                type="file"
                                name="file"
                                accept="image/*"
                                class="form-control"
                                required
                        />
                    </div>
                    <button type="submit" class="btn btn-primary mb-3">
                        Upload Photo
                    </button>
                </noscript>

                <div class="d-flex justify-content-between">
                    <button
                            type="button"
                            class="btn btn-secondary"
                            onclick="history.back()"
                    >
                        ‚Üê Back
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    (function(){
      const form = document.getElementById('uploadForm');
      const apiUrl = form.getAttribute('data-api-url');
      const fileInput = document.getElementById('fileInput');

      fileInput.addEventListener('change', async () => {
        const formData = new FormData(form);

        try {
          const res = await fetch(apiUrl, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
          });

          if (res.ok) {
            // desktop: JSON upload succeeded ‚Üí go straight to gallery
            window.location.href = '/gallery';
          } else {
            // mobile (or any) fallback ‚Üí plain form‚Äêsubmit to /upload
            console.warn('AJAX upload failed:', res.status);
            form.submit();
          }
        } catch (err) {
          console.warn('Fetch error, falling back to form submit', err);
          form.submit();
        }
      });
    })();
  </script>
</body>
</html>
